# Tech Pack Translator - 架构设计文档

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Tech Pack Translator System                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │   CLI Entry  │    │  API Service │    │ Batch Runner │     │
│  │  (main.py)   │    │   (api.py)   │    │              │     │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘     │
│         │                   │                    │              │
│         └───────────────────┴────────────────────┘              │
│                             │                                    │
│                    ┌────────▼─────────┐                         │
│                    │  TechPackTranslator│                       │
│                    │    (pipeline.py)   │                       │
│                    └────────┬──────────┘                        │
│                             │                                    │
│         ┌───────────────────┼───────────────────┐              │
│         │                   │                   │               │
│  ┌──────▼──────┐    ┌──────▼──────┐    ┌──────▼──────┐       │
│  │ Preprocessor│    │   Design    │    │ OCR Engine  │       │
│  │             │    │  Detector   │    │             │       │
│  └─────────────┘    └─────────────┘    └─────────────┘       │
│                                                                  │
│         ┌───────────────────┬───────────────────┐              │
│         │                   │                   │               │
│  ┌──────▼──────┐    ┌──────▼──────┐    ┌──────▼──────┐       │
│  │ Translator  │    │  Renderer   │    │   Config    │       │
│  │             │    │             │    │   Manager   │       │
│  └─────────────┘    └─────────────┘    └─────────────┘       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 模块职责

### 1. CLI Entry (main.py)
- 命令行参数解析
- 用户交互
- 调用Pipeline执行翻译

### 2. API Service (api.py)
- RESTful API接口
- 文件上传下载
- 异步处理

### 3. Pipeline (pipeline.py)
- 流程编排
- 模块协调
- 统计收集

### 4. Preprocessor (preprocessor.py)
- 图像加载
- 图像增强
- 倾斜校正
- 噪声去除

### 5. Design Detector (design_detector.py)
- 文本标注检测
- 视觉特征分析
- 箭头追踪
- 保护蒙版生成

### 6. OCR Engine (ocr_engine.py)
- 多引擎支持 (PaddleOCR, Tesseract, EasyOCR)
- 文字检测
- 文字识别
- 置信度评估

### 7. Translator (translator.py)
- 多翻译引擎支持
- 术语库管理
- 翻译缓存
- 后处理

### 8. Renderer (renderer.py)
- 背景修复
- 字体选择
- 文字渲染
- 布局保持

## 数据流

```
Input Image
    │
    ▼
┌─────────────────┐
│ 1. Preprocessing │ ──► Enhanced Image
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 2. Initial OCR  │ ──► OCR Results (for detection)
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 3. Detection    │ ──► Design Regions + Protection Mask
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 4. Full OCR     │ ──► Filtered OCR Results
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 5. Translation  │ ──► Translation Results
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 6. Rendering    │ ──► Output Image
└─────────────────┘
```

## 算法流程图

### 主流程
```
START
  │
  ▼
加载配置
  │
  ▼
图像预处理 ────► 增强图像
  │                │
  │                ▼
  │            保存调试图 (如启用)
  │                │
  ▼                ▼
初步OCR ─────► OCR结果
  │
  ▼
检测设计包图像 ──┬──► 找到标注?
  │              │      │
  │              │      ├─ Yes ──► 追踪箭头 ──► 确定区域
  │              │      │
  │              │      └─ No ───► 视觉特征检测
  │              │
  │              ▼
  │         生成保护蒙版
  │              │
  ▼              ▼
完整OCR ────► 排除保护区域 ──► 有效文本区域
  │
  ▼
翻译循环 ─────┬─► 遍历每个文本
  │           │
  │           ├─ 检查术语库 ──► 命中? ──► 使用术语翻译
  │           │                   │
  │           │                   └─ No ──► 使用翻译引擎
  │           │
  │           └─ 后处理 ──► 格式保持
  │
  ▼
渲染 ─────────┬─► 清除原文字区域
  │           │
  │           ├─ 选择合适字体
  │           │
  │           ├─ 计算位置
  │           │
  │           └─ 渲染译文
  │
  ▼
恢复保护区域
  │
  ▼
保存输出
  │
  ▼
生成统计
  │
  ▼
END
```

### 设计图案检测详细流程
```
检测设计包图像
  │
  ├─ 方法1: 文本标注
  │   │
  │   ├─ OCR识别所有文本
  │   │
  │   ├─ 查找关键词 ("Design Pack Image")
  │   │
  │   ├─ 检测箭头/指示线
  │   │   │
  │   │   ├─ 边缘检测 (Canny)
  │   │   │
  │   │   └─ 霍夫变换检测直线
  │   │
  │   ├─ 追踪箭头指向
  │   │
  │   └─ 确定目标区域边界
  │
  ├─ 方法2: 视觉特征
  │   │
  │   ├─ HSV色彩空间转换
  │   │
  │   ├─ 分析饱和度
  │   │
  │   ├─ 检测高饱和度区域
  │   │
  │   ├─ 形态学操作连接区域
  │   │
  │   └─ 轮廓检测获取边界
  │
  └─ 生成保护蒙版
      │
      ├─ 创建空白蒙版
      │
      ├─ 标记保护区域
      │
      └─ 添加保护边距
```

### OCR识别流程
```
OCR识别
  │
  ├─ 引擎选择
  │   │
  │   ├─ PaddleOCR (推荐)
  │   │   │
  │   │   ├─ 文本检测 (DBNet)
  │   │   │
  │   │   ├─ 方向分类
  │   │   │
  │   │   └─ 文本识别 (CRNN)
  │   │
  │   ├─ Tesseract
  │   │   │
  │   │   └─ 直接识别
  │   │
  │   └─ EasyOCR
  │       │
  │       └─ 深度学习识别
  │
  ├─ 文本区域检测
  │   │
  │   └─ 返回边界框坐标
  │
  ├─ 文本识别
  │   │
  │   └─ 返回文本 + 置信度
  │
  ├─ 过滤保护区域
  │   │
  │   ├─ 检查每个文本框
  │   │
  │   ├─ 计算中心点
  │   │
  │   └─ 检查是否在保护蒙版内
  │
  └─ 返回有效结果
```

### 翻译流程
```
翻译
  │
  ├─ 文本预处理
  │   │
  │   └─ 清理空格、特殊字符
  │
  ├─ 检查缓存
  │   │
  │   ├─ 命中 ──► 返回缓存结果
  │   │
  │   └─ 未命中 ──► 继续
  │
  ├─ 判断是否需要翻译
  │   │
  │   ├─ 纯数字 ──► 保持不变
  │   │
  │   ├─ 代码/编号 ──► 保持不变
  │   │
  │   └─ 普通文本 ──► 继续
  │
  ├─ 查询术语库
  │   │
  │   ├─ 精确匹配
  │   │
  │   ├─ 不区分大小写匹配
  │   │
  │   └─ 部分匹配
  │
  ├─ 调用翻译引擎
  │   │
  │   ├─ Google Translate
  │   │
  │   ├─ DeepL
  │   │
  │   └─ 本地模型 (Marian)
  │
  ├─ 后处理
  │   │
  │   ├─ 格式保持 (冒号、括号)
  │   │
  │   ├─ 百分号保留
  │   │
  │   └─ 空格规范化
  │
  └─ 缓存结果
```

### 渲染流程
```
渲染
  │
  ├─ 准备画布
  │   │
  │   └─ 转换为PIL Image
  │
  ├─ 遍历每个翻译结果
  │   │
  │   ├─ 清除原文字
  │   │   │
  │   │   ├─ 检测背景色
  │   │   │
  │   │   └─ 填充背景
  │   │
  │   ├─ 选择字体
  │   │   │
  │   │   ├─ 估算原字号
  │   │   │
  │   │   ├─ 自适应调整
  │   │   │
  │   │   └─ 选择最合适字体
  │   │
  │   ├─ 计算位置
  │   │   │
  │   │   ├─ 测量文字尺寸
  │   │   │
  │   │   └─ 居中对齐
  │   │
  │   └─ 渲染文字
  │       │
  │       └─ 绘制到画布
  │
  ├─ 恢复保护区域
  │   │
  │   ├─ 应用保护蒙版
  │   │
  │   └─ 从原图复制
  │
  └─ 转换输出格式
```

## 配置系统

```
config/
  │
  ├─ config.yaml ─────► 主配置文件
  │   │
  │   ├─ ocr ──────────► OCR引擎配置
  │   │
  │   ├─ translation ──► 翻译配置
  │   │
  │   ├─ detection ────► 检测配置
  │   │
  │   ├─ rendering ────► 渲染配置
  │   │
  │   └─ output ───────► 输出配置
  │
  └─ terminology.json ─► 专业术语库
      │
      ├─ fabric_materials
      │
      ├─ garment_parts
      │
      ├─ construction
      │
      └─ do_not_translate
```

## 错误处理

```
Error Handling
  │
  ├─ 图像加载错误
  │   └─ 检查文件格式和路径
  │
  ├─ OCR失败
  │   ├─ 降低阈值重试
  │   └─ 尝试其他引擎
  │
  ├─ 设计图案未检测到
  │   ├─ 使用视觉特征检测
  │   └─ 提示用户手动标注
  │
  ├─ 翻译失败
  │   ├─ 使用缓存
  │   └─ 保持原文
  │
  └─ 渲染错误
      ├─ 调整字号
      └─ 使用默认字体
```

## 性能优化

1. **缓存机制**
   - OCR结果缓存
   - 翻译结果缓存
   - 字体对象缓存

2. **并行处理**
   - 批量OCR
   - 批量翻译
   - 多进程处理

3. **GPU加速**
   - OCR检测
   - OCR识别
   - 图像处理

4. **内存优化**
   - 流式处理大图
   - 及时释放中间结果
   - 使用生成器

## 扩展性

系统设计支持以下扩展：

1. **新增OCR引擎**
   - 实现OCREngine接口
   - 在配置中添加选项

2. **新增翻译引擎**
   - 实现Translator接口
   - 添加API配置

3. **新增检测方法**
   - 扩展DesignDetector
   - 添加新的检测策略

4. **新增输出格式**
   - 扩展Renderer
   - 支持PDF、SVG等

## 测试策略

```
Testing
  │
  ├─ 单元测试
  │   ├─ 各模块独立测试
  │   └─ 覆盖核心功能
  │
  ├─ 集成测试
  │   └─ 完整流程测试
  │
  └─ 性能测试
      ├─ 速度基准
      └─ 内存使用
```
